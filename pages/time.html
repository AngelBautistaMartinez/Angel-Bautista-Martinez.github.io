<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time - Angel Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        .header {
            background-color: #000000;
            padding: 30px 20px;
            text-align: center;
            border-bottom: 3px solid #1a1a1a;
        }

        .back-button {
            display: inline-block;
            background-color: #dc143c;
            color: #ffffff;
            padding: 10px 25px;
            border-radius: 5px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }

        .back-button:hover {
            background-color: #b01030;
        }

        .page-title {
            font-size: 2.5em;
            font-weight: 300;
            letter-spacing: 3px;
            margin-top: 10px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h3 {
            color: #dc143c;
            font-size: 1.5em;
            margin-top: 50px;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .explanation {
            background-color: #1a1a1a;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc143c;
        }

        .explanation p {
            margin-bottom: 15px;
            font-size: 1.05em;
            line-height: 1.8;
        }

        .explanation p:last-child {
            margin-bottom: 0;
        }

        .code-section {
            margin-bottom: 40px;
        }

        .code-label {
            color: #ffffff;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        pre {
            background-color: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        code {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.95em;
        }

        .inline-code {
            background-color: #1a1a1a;
            color: #ce9178;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="back-button">‚Üê Back to Home</a>
        <div class="page-title">Time</div>
    </div>

    <div class="container">
        <h3>1. Rdtsc</h3>

        <div class="explanation">
            <p>VMs have a problem with the rdtsc instruction. When rdtsc is executed by a program running on a virtual processor, the virtual processor must pass this instruction on to the "real" processor - the hardware CPU that runs the host OS. Passing the rdtsc instruction to the real CPU and back again causes some latency, which in turn increases the number of ticks. When malware sees that this returned tick count is higher than it would be on a non-virtualized system, it might detect a VM.</p>
            <p>The CPU on the host might not support the __cpuid asm instruction as it was recently added and may not be an option in the CPU.</p>
        </div>

        <div class="code-section">
            <span class="code-label">C/C++ Code</span>
            <pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;intrin.h&gt;
#include &lt;inttypes.h&gt;

//works for 32 and 64 bit
unsigned long long checkTSC(){
    return __rdtsc();
}

unsigned int checkCPUMHz(){
    int cpuInfo[4] = {0};
    /*
    cpuInfo[0] = EAX
    cpuInfo[1] = EBX
    cpuInfo[2] = ECX
    cpuInfo[3] = EDX
    */
    //ask CPU for information about itself we pass where to put the info and also we tell it we
    //want 0x16 which is EAX=0x16 when calling this function which is where the CPU info is at(the hertzs)
    __cpuid(cpuInfo, 0x16);
    
    if(cpuInfo[0] != 0){
        return cpuInfo[0];
    }
    else{
        printf("CPU doesn't fully support __cpuid\n");
        return 0;
        
    }
}

int checkRDTSC(){
    int sleepNumber = 1000;
    unsigned long long start = checkTSC();

    Sleep(sleepNumber);
    //ps use long long cuz the # of ticks are a large #
    unsigned long long end = checkTSC();

    unsigned long long final = end - start;

    unsigned int MHz = checkCPUMHz();

    

    if(MHz &gt; 0){
        unsigned long long expected = (unsigned long long)MHz * 1000000ULL * sleepNumber / 1000ULL;
        unsigned long long lower = expected / 2;
        unsigned long long higher = expected * 2;
        printf("Measured %llu cycles Expected %llu\n", final, expected);
        

        if(final&lt;lower || final&gt;higher){
            //vm
            return 1;
        }
        else{
            //not vm
            return 0;
        }
    }
    if(MHz == 0){
        return 3;
    }
    
    
    

}

int main(){
    if(checkRDTSC() == 0){
        printf("Not VM");
    }
    else if(checkRDTSC() == 1){
        printf("!!VM!!");
    }
}</code></pre>
        </div>

        <h3>2. Checking Sleep Hook via GetTickCount</h3>

        <div class="explanation">
            <p>Checking if the sleep function is hooked via comparing it with GetTickCount to see if the sleep function really waited the seconds you put in.</p>
        </div>

        <div class="code-section">
            <span class="code-label">C/C++ Code</span>
            <pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

int checkSleepHook(){
    //gets current tick count(milliseconds since windows started)
    DWORD start = GetTickCount();

    Sleep(3000);

    DWORD end = GetTickCount();

    DWORD elapsed = end - start;

    //if sleep was hooked and skipped elapsed will be much less than 3000ms
    if(elapsed &lt; 2900){
        //Sleep was hooked or skipped
        return 1;
    }
    else{
        //Sleep worked normally
        return 0;
    }
}

int main(){
    if(checkSleepHook() == 0){
        printf("Carry on, no VM\n");
    }
    else{
        printf("!!HOOKED FUNCTION!!\n");
    }
    return 0;
}</code></pre>
        </div>

        <h3>3. Checking Sleep Hook via QueryPerformanceCounter</h3>

        <div class="explanation">
            <p>Similar to checking if sleep is hooked by getting GetTickCount(). This technique uses QueryPerformanceCounter instead of GetTickCount() because it's more precise since it's in microseconds.</p>
        </div>

        <div class="code-section">
            <span class="code-label">C/C++ Code</span>
            <pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

int checkSleepHook(){
    //64-bit int struct used for high resolution timers
    LARGE_INTEGER freq, start, end;
    //get ticks per sec for freq
    QueryPerformanceFrequency(&freq);

    //puts the current counter value to start
    QueryPerformanceCounter(&start);

    Sleep(3000);

    //read counter again after 3 sec's should have passed
    QueryPerformanceCounter(&end);

    double time = (double)(end.QuadPart - start.QuadPart) / freq.QuadPart;

    if(time &lt; 2.9){
        //Hooked
        exit(0);
    }
    else{
        //normal
        return 0;
    }
}

int main(){
    if (checkSleepHook() == 0){
        printf("Carry on, no VM\n");
    }
    else{
        printf("!!HOOKED FUNCTION!!\n");
    }
    return 0;
}</code></pre>
        </div>

        
       

    </div>

    <script>
        hljs.highlightAll();
    </script>
</body>
</html>
